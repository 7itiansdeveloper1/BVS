@model ISas.Web.ViewModels.Exam_RemarkViewModel
@{
    ViewBag.Title = "General Remarks Entry Form";
}

<section class="content-header">
    <h1>
        Remarks Entry
    </h1>
    <ol class="breadcrumb">
        <li>
            <a href="javascript: history.go(-1)" title="Back"><i class="fa fa-arrow-left"></i> </a> |
            <a href="#" onclick="window.location.reload()" title="Refresh"><i class="fa fa-refresh"></i></a> |
            <a href="@Url.Action("Dashboard", "Dashboard")" title="Dashboard"><i class="fa fa-dashboard"></i></a>
        </li>
        <li><a href="#">CCE Exam Module</a></li>
        <li class="active">Remarks</li>
    </ol>
</section>


<section class="content">
    <div class="box box-success">
        <div class="box-header with-border">
            <h5 class="box-title pull-right">
                <a href="#" onclick="exportToExcel('AchievementTable')" id="btnExport" title="Export to Excel" class="fa fa-file-excel-o btnDefaultColor"></a>
            </h5>
            <span class="box-title pull-right" style="padding-right:0.7%;">
                <a href="#" onclick="printRemarks()" id="btnPrint" title="Print"  class="fa fa-print btnDefaultColor"></a>
            </span>
        </div>
        <div class="box-body">
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="form-group">
                        <label for="">Session</label>
                        <div class="select">
                            @Html.HiddenFor(r => Model.SelectedSessionId)
                            @Html.DropDownListFor(m => m.SelectedSessionId, Model.SessionList, new { @class = "form-control select2", style = "width:100%;", disabled = "disabled" })
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="form-group">
                        <label for="">Term</label>
                        <div class="select">
                            @Html.DropDownListFor(m => m.SelectedExamId, Model.ExamList, "-- Select Exam --", new { @class = "form-control select2", style = "width:100%;", onchange = "getClassList()" })
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="form-group">
                        <label for="">Class</label>
                        <div class="select">
                            @Html.DropDownListFor(m => m.SelectedClassId, Model.ClassList, new { @class = "form-control select2", style = "width:100%;", onchange = "getSectionList()" })
                        </div>
                    </div>
                </div>
                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="form-group">
                        <label for="">Section</label>
                        <div class="select">
                            @Html.DropDownListFor(m => m.SelectedSectionId, Model.SectionList, new { @class = "form-control select2", style = "width:100%;", onchange = "getStudentList()" })
                        </div>
                    </div>

                </div>
                <div class="col-xs-12 col-sm-6 col-md-3">
                    <div class="form-group">
                        <label for="">Remark Options</label>
                        <div class="select">
                            @Html.DropDownList("ddlOption", new List<SelectListItem>
                                                                                        {
                                                                                        new SelectListItem{ Text="-----Select-----", Value = "0" ,Selected=true },
                                                                                        new SelectListItem{ Text="VIEW", Value = "RemarkView" },
                                                                                        new SelectListItem{ Text="ENTRY", Value = "RemarkEntry" },
                                                                                         }, new { @class = "form-control select2", style = "width:100%;", onchange = "getStudentList()" })
                        </div>
                    </div>
                </div>
                <div id="divAchievementList">
                    @Html.Partial("_StudentRemarkListPartial", Model)
                </div>
            </div>
        </div>
        <div class="box-footer">
            <button class="btn btn-success" id="savebutton">SAVE</button>
        </div>
    </div>
</section>


<script type="text/javascript">
    function printRemarks() {
        var html = $('#headerMain').html();
        html += $('#divAchievementList').html();
        var w = window.open();
        $(w.document.body).html(html);
        w.print();
        //w.close();
    }

    function myfunction() {
        var myTableArray = [];
        $('#AchievementTable tr:not(:first)').each(function () {
            var tds = $(this).find('td');
            var myDets;
            myDets = {
                StudentERPNo: $(tds[0]).html(),
                RemarkId: $(tds[4]).find(":selected").val()
            }
            myTableArray.push(myDets);
        });
        return myTableArray;
    }


    function getClassList() {
        $.ajax({
            url:'../Exam_Remark/BindClassddl',
            data: { examId: $('#SelectedExamId').val() },
            type: 'get',
            success: (function (data) {
                var $ddlClass = $('#SelectedClassId');
                $ddlClass.empty();
                $ddlClass.append($("<option />").text("--- Select Class ---"));
                $.each(data, function () {
                    $ddlClass.append($("<option />").val(this.ClassId).text(this.ClassName));
                })
            })
        })
    }


    function getSectionList() {
        $.ajax({
            url: '../Exam_Remark/BindSectionddl',
            data: { classId: $('#SelectedClassId').val(), examId: $('#SelectedExamId').val() },
            type: 'get',
            success: (function (data) {
                var $ddlSec = $('#SelectedSectionId');
                $ddlSec.empty();
                $ddlSec.append($("<option />").text("--- Select Section ---"));
                $.each(data, function () {
                    $ddlSec.append($("<option />").val(this.SecId).text(this.SecName));
                })
            })
        })
    }

    function getStudentList() {

        var selectedOption = $('#ddlOption :selected').text();
        if (selectedOption == "VIEW") {
            $('#btnPrint').attr('disabled', false);
            $('#savebutton').attr('disabled', true);

            $('#btnExport').attr('disabled', false);
            $('#btnPrint').attr('disabled', false);

        } else if (selectedOption == "ENTRY") {
            $('#btnPrint').attr('disabled', true);
            $('#savebutton').attr('disabled', false);

            $('#btnExport').attr('disabled', true);
            $('#btnPrint').attr('disabled', true);
        }

        $.ajax({
            url: '../Exam_Remark/BindStudentRemarkGrid',
            data: {
                classId: $('#SelectedClassId').val(), sectionId: $('#SelectedSectionId').val(),
                examId: $('#SelectedExamId').val(),
                sessionId: $('#SelectedSessionId').val(), Mode: $('#ddlOption').val(),
                TermName: $('#SelectedExamId :selected').text(),
                ClassName: $('#SelectedClassId :selected').text(),
                SectionName: $('#SelectedSectionId :selected').text()
            },
            type: 'get',
            success : (function (data) {
                $('#divAchievementList').empty();
                $('#divAchievementList').html(data);
            })
        })
    }


    $(document).ready(function () {
        $('#savebutton').on("click", function () {
            var myTableArray = myfunction();
            event.preventDefault();
            if ( $('#ddlOption :selected').text()== "ENTRY")
            {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("Exam_Remark_CRUD", "Exam_Remark")',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(
                        {
                            examId: $('#SelectedExamId').val(),
                            sessionId: $('#SelectedSessionId').val()
                            , StudentRemarkList: myTableArray
                        }),
                    success: function (result) {
                        OpenMessegeAutoHideDiv(result.Msg, result.Color);
                    },
                    error: function () {
                        OpenMessegeAutoHideDiv($('#ErrorMsgOnJasonFailed').val(), 'Danger');
                    }
                });
            }
        });
    });
</script>

